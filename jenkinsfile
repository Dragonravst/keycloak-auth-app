pipeline {
    agent any  // Runs on any available Jenkins agent

    environment {
        DOCKER_IMAGE = 'my-auth-app'
        DOCKER_TAG = "${env.BUILD_NUMBER}"  // Tags with Jenkins build number
        KEYCLOAK_CONTAINER = 'keycloak_v2'
        APP_CONTAINER = 'my-auth-app'
    }

    stages {
        stage('Checkout') {
            steps {
                // Pull code from GitHub
                checkout scm
            }
        }

        stage('Start Dependencies') {
            steps {
                script {
                    // Check if Keycloak container is running
                    def keycloakRunning = bat(
                        script: "docker ps -q -f name=${KEYCLOAK_CONTAINER}",
                        returnStdout: true
                    ).trim()

                    if (keycloakRunning) {
                        echo "Keycloak container is already running, skipping start."
                    } else {
                        echo "Starting Keycloak container..."
                        bat "docker-compose up -d keycloak"
                        // Wait for services to be ready
                        bat "timeout /t 30 /nobreak"  // Wait 30 seconds
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    // Build the app's Docker image
                    bat "docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} ."
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    // Optional: Run tests inside the container
                    // bat "docker run --rm ${DOCKER_IMAGE}:${DOCKER_TAG} npm test"
                    echo "Skipping tests for now (add 'npm test' if needed)"
                }
            }
        }

        stage('Deploy/Run Container') {
            steps {
                script {
                    // Stop and remove old app container if it exists
                    def appRunning = bat(
                        script: "docker ps -q -f name=${APP_CONTAINER}",
                        returnStdout: true
                    ).trim()

                    if (appRunning) {
                        echo "Stopping old app container..."
                        bat "docker stop ${APP_CONTAINER}"
                        bat "docker rm ${APP_CONTAINER}"
                    }

                    // Run the new app container
                    bat """
docker run -d --name ${APP_CONTAINER} ^
  -p 3000:3000 ^
  --network keycloak-net ^
  -e NODE_ENV=development ^
  -e PORT=3000 ^
  -e DB_HOST=host.docker.internal ^
  -e DB_PORT=5432 ^
  -e DB_NAME=keycloak_db ^
  -e DB_USER=postgres ^
  -e DB_PASS=Akash ^
  -e KEYCLOAK_URL=http://${KEYCLOAK_CONTAINER}:8080 ^
  -e KEYCLOAK_REALM=keycloak_auth ^
  -e KEYCLOAK_CLIENT_ID=keycloakv1 ^
  -e KEYCLOAK_CLIENT_SECRET=tAweFy2M5wPoZVnlRpjJdSalabmDcUdL ^
  -e KEYCLOAK_ADMIN_CLIENT_ID=admin-cli ^
  -e KEYCLOAK_ADMIN_CLIENT_SECRET=r2Hc1OiU9UBtq6pxVuQVMnlR9Kxuqpe3 ^
  -e SESSION_SECRET=mysessionsecretcodepassword ^
  -e JWT_SECRET=secrettokenusedforthejwt ^
  ${DOCKER_IMAGE}:${DOCKER_TAG}
"""
                }
            }
        }

        stage('Health Check') {
            steps {
                script {
                    // Wait and verify the app is healthy
                    bat "timeout /t 10 /nobreak"  // Wait 10 seconds
                    bat 'powershell -Command "Invoke-WebRequest http://localhost:3000/health -UseBasicParsing"'
                }
            }
        }
    }

    post {
        always {
            // Cleanup dangling images
            bat 'docker image prune -f'
            // Stop all services from docker-compose
            echo 'Stopping any docker-compose services...'
            bat 'docker-compose down || exit 0'
        }
        success {
            echo 'Pipeline succeeded!'
        }
        failure {
            echo 'Pipeline failed. Check logs for details.'
        }
    }
}
